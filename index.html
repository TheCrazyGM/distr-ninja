<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>distriator.ninja</title>
    <!-- Bootstrap 5 CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  </head>

  <body class="bg-light">
    <!-- Navbar -->
    <nav
      class="navbar navbar-expand-lg navbar-light bg-white border-bottom mb-4"
    >
      <div class="container-fluid">
        <a class="navbar-brand" href="#"><i class="fa-solid fa-user-ninja"></i> distriator.ninja</a>
        <div class="ms-auto" id="login-area">
          <!-- Login form or user info will be injected here -->
        </div>
      </div>
    </nav>
    <div class="container mt-4">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">Claims Status</h4>
            <p id="status" class="mb-0 text-danger"></p>
          </div>
          <div id="claims-container"></div>
        </div>
      </div>
    </div>
    <footer class="text-center py-4 text-muted">
      <small>
        <i class="fa-solid fa-code"></i> with <i class="fa-solid fa-heart text-danger"></i> by <a href="https://peakd.com/@thecrazygm" target="_blank" class="text-decoration-none">@thecrazygm</a>
      </small>
    </footer>
    <script>
      // Generate current UTC datetime in ISO 8601 format with milliseconds and 'Z'
      function getCurrentUTCDateTime() {
        const now = new Date();
        // toISOString() returns format like 2025-05-19T12:54:25.218Z
        return now.toISOString();
      }

      function showLoginForm() {
        document.getElementById("login-area").innerHTML = `
                <form class="d-flex align-items-center" id="loginForm" autocomplete="off">
                    <input type="text" class="form-control me-2" id="username" placeholder="Hive username" autocomplete="username" style="width: 180px;">
                    <button class="btn btn-primary me-2" id="loginBtn" type="submit">Login & Sign</button>
                </form>
            `;
        document
          .getElementById("loginForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            loginAndFetchClaims();
          });
      }

      function showUserNav(username) {
        document.getElementById("login-area").innerHTML = `
                <span class="me-3"><i class="fa-solid fa-user"></i> <b>${username}</b></span>
                <button class="btn btn-outline-secondary btn-sm" id="logoutBtn">Logout</button>
            `;
        document.getElementById("logoutBtn").onclick = logout;
      }

      function loginAndFetchClaims() {
        const datetimeToSign = getCurrentUTCDateTime();
        const username = document.getElementById("username").value.trim();
        const status = document.getElementById("status");
        status.textContent = "";

        if (!username) {
          status.textContent = "Please enter your Hive username.";
          return;
        }

        if (typeof window.hive_keychain === "undefined") {
          status.textContent = "Hive Keychain extension not detected!";
          return;
        }

        // Request to sign the memo (datetime string) with the user's memo key
        window.hive_keychain.requestSignBuffer(
          username,
          datetimeToSign, // now dynamically generated in UTC ISO format
          "Posting",
          function (response) {
            if (response.success) {
              status.textContent =
                "Posting signed successfully! Sending to API...";
              const proof = response.result;
              const pubkey =
                response.publicKey ||
                (response.data && response.data.publicKey) ||
                null;
              if (!pubkey) {
                status.textContent =
                  "Could not retrieve public key from Keychain response.";
                return;
              }
              // Prepare payload
              const payload = {
                challenge: proof, // signature as challenge
                username: username,
                pubkey: pubkey,
                proof: datetimeToSign, // datetime as proof
              };

              // Send to API
              fetch("https://beta-api.distriator.com/login", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(payload),
              })
                .then((res) => res.json())
                .then((apiRes) => {
                  if (apiRes.token) {
                    // Save token and type to localStorage
                    localStorage.setItem("distriator_token", apiRes.token);
                    if (apiRes.type) {
                      localStorage.setItem("distriator_type", apiRes.type);
                    }
                    status.textContent =
                      "Login successful! Token and type saved.";
                    showUserNav(username);
                    // Fetch claims and display them
                    fetchClaimsAndDisplay();
                  } else {
                    status.textContent = `API response: ${apiRes.message || JSON.stringify(apiRes)}`;
                    status.className = "mb-0 text-danger";
                  }
                })
                .catch((err) => {
                  status.textContent = `API call failed: ${err}`;
                  status.className = "mb-0 text-danger";
                });
            } else {
              status.textContent = `Failed to sign posting: ${response.message || "Unknown error"}`;
              status.className = "mb-0 text-danger";
            }
          },
        );
      }

      // Logout function
      function logout() {
        localStorage.removeItem("distriator_token");
        localStorage.removeItem("distriator_type");
        document.getElementById("claims-container").innerHTML = "";
        document.getElementById("status").textContent = "";
        showLoginForm();
      }

      // Helper for authenticated API requests
      function distriatorFetch(url, options = {}) {
        const token = localStorage.getItem("distriator_token");
        if (!options.headers) options.headers = {};
        if (token) {
          options.headers["Authorization"] = "Bearer " + token;
        }
        return fetch(url, options);
      }

      // Format currency value
      function formatCurrency(value) {
        if (typeof value === "string") {
          return value; // Already formatted (e.g., "1.000 HBD")
        }
        return new Intl.NumberFormat("en-US", {
          minimumFractionDigits: 3,
          maximumFractionDigits: 3,
        }).format(value);
      }

      // Create a post form for a specific claim
      function createPostForm(claim, claimId) {
        return `
        <div class="card shadow-sm mb-4" id="post-form-${claimId}">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Create Post for Invoice: ${claim.invoice}</h5>
                <button class="btn btn-light btn-sm" onclick="toggleClaimView('${claimId}')">Back to Claim</button>
            </div>
            <div class="card-body">
                <form class="needs-validation" novalidate onsubmit="createHivePost(event, '${claimId}')">
                    <div class="mb-3">
                        <label for="postTitle-${claimId}" class="form-label">Title</label>
                        <input type="text" class="form-control" id="postTitle-${claimId}" required>
                        <div class="invalid-feedback">Please provide a title.</div>
                    </div>
                    <div class="mb-3">
                        <label for="postBody-${claimId}" class="form-label">Body</label>
                        <div class="alert alert-info mb-2">
                            <strong>Important:</strong> Your review must include at least 2 pictures of the product/service to qualify for the claim.
                            Use markdown image syntax: ![description](image_url)
                        </div>
                        <textarea class="form-control" id="postBody-${claimId}" rows="6" required></textarea>
                        <div class="invalid-feedback">Please provide content for your post.</div>
                        <div class="form-text">Write your post in Markdown format. Remember to include at least 2 images!</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Post</button>
                </form>
            </div>
        </div>
        `;
      }

      // Create a claim card
      function createClaimCard(claim, index) {
        const date = new Date(claim.timestamp);
        const formattedDate = date.toLocaleString();
        const claimId = `claim-${index}`;

        return `
        <div class="claim-container" id="${claimId}">
            <div class="claim-view">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Invoice: ${claim.invoice}</h5>
                        <div>
                            <span class="badge bg-light text-primary me-2">${claim.amount}</span>
                            <button class="btn btn-light btn-sm" onclick="toggleClaimView('${claimId}')">Claim</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Business:</strong> ${claim.business}</p>
                                <p class="mb-1"><strong>Country:</strong> ${claim.country}</p>
                                <p class="mb-1"><strong>Date:</strong> ${formattedDate}</p>
                                <p class="mb-1"><strong>Payment Method:</strong> ${claim.paymentMethod}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Claim Value:</strong> ${claim.claimValue}</p>
                                <p class="mb-1"><strong>Percentage:</strong> ${claim.percentage}</p>
                                <p class="mb-1"><strong>Transaction Amount:</strong> ${claim.transactionAmount}</p>
                            </div>
                        </div>

                        ${
                          claim.guides && claim.guides.length > 0
                            ? `
                        <div class="mt-3">
                            <h6 class="mb-2">Guides</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Percent</th>
                                            <th>Guides Percent</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${claim.guides
                                          .map(
                                            (guide) => `
                                        <tr>
                                            <td>${guide.name}</td>
                                            <td>${guide.percent}</td>
                                            <td>${guide.guidesPercent}</td>
                                            <td>${guide.value}</td>
                                        </tr>
                                        `,
                                          )
                                          .join("")}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        `
                            : ""
                        }

                        ${
                          claim.onborder
                            ? `
                        <div class="mt-3">
                            <h6 class="mb-2">Onborder</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Name:</strong></td>
                                        <td>${claim.onborder.name}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Percent:</strong></td>
                                        <td>${claim.onborder.percent}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Value:</strong></td>
                                        <td>${claim.onborder.value}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        `
                            : ""
                        }
                    </div>
                </div>
            </div>
            <div class="post-form" style="display: none;">
                ${createPostForm(claim, claimId)}
            </div>
        </div>
        `;
      }

      // Fetch claims and display them on the page
      function fetchClaimsAndDisplay() {
        const container = document.getElementById("claims-container");
        container.innerHTML =
          '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        distriatorFetch("https://beta-api.distriator.com/claims/v2")
          .then((res) => res.json())
          .then((data) => {
            if (data.claim) {
              // Store claims data globally with index
              window._claimsData = [{ claim: data.claim, index: 0 }];
              container.innerHTML = createClaimCard(data.claim, 0);
            } else {
              container.innerHTML =
                '<div class="alert alert-info">No claims found.</div>';
            }
          })
          .catch((err) => {
            container.innerHTML = `<div class="alert alert-danger">Failed to fetch claims: ${err}</div>`;
          });
      }

      // Toggle between claim view and post form
      function toggleClaimView(claimId) {
        const container = document.getElementById(claimId);
        const claimView = container.querySelector(".claim-view");
        const postForm = container.querySelector(".post-form");

        if (claimView.style.display !== "none") {
          claimView.style.display = "none";
          postForm.style.display = "block";
        } else {
          claimView.style.display = "block";
          postForm.style.display = "none";
        }
      }

      // Create and submit Hive post
      function createHivePost(event, claimId) {
        event.preventDefault();
        const form = event.target;
        if (!form.checkValidity()) {
          form.classList.add("was-validated");
          return;
        }

        const title = document
          .getElementById(`postTitle-${claimId}`)
          .value.trim();
        let body = document.getElementById(`postBody-${claimId}`).value.trim();
        const username = document.querySelector("#login-area b")?.textContent;

        if (!username) {
          document.getElementById("status").textContent = "Please login first.";
          return;
        }

        // Get the claim data from the stored claims
        const claimData = window._claimsData?.find(
          (c) => `claim-${c.index}` === claimId,
        )?.claim;
        if (!claimData) {
          document.getElementById("status").textContent =
            "No claim data available. Please refresh the page.";
          return;
        }

        // Append the template with claim data
        const template = `

---

Business name: [${claimData.business}](https://distriator.com/#/businesses/${encodeURIComponent(claimData.business.toLowerCase())})
[Open SpendHBD Business Page]()

Paid Amount: ${claimData.amount}
Rewards Claimed: ${claimData.claimValue} (${claimData.percentage} of ${claimData.amount})

To benefit from Distriator and receive discounts on your Hive Dollars purchases:

1. Spend Hive Dollars at listed businesses on Distriator (See business list here - <https://distriator.com/#/businesses>).
2. Make sure business issues a QR Invoice from v4v.app / Hive-Keychain app.
3. Go to <https://distriator.com>, log in, follow the instructions, and make your claim.
`;

        // Append template to user's body text
        body = body + template;

        const jsonMetadata = {
          app: "distriator.ninja/0.0.0",
          business_display_name: claimData.business,
          business_name: claimData.business.toLowerCase().replace(/\s+/g, "-"),
          claim_percent: claimData.percentage,
          claim_value: claimData.claimValue,
          developer: "thecrazygm",
          format: "markdown",
          guides_percent:
            claimData.guides?.[0]?.percent?.replace(" %", "") || "0",
          image: [], // Can be populated if needed
          invoice_id: claimData.invoice,
          invoice_memo: claimData.memo,
          spend_hbd_link: "",
          tags: ["spendhbd", "distriator", "spendtoearn"],
          team: "mithril.destiny",
          total_value: claimData.amount,
          unique_business_invoice_id: `${claimData.business.toLowerCase().replace(/\s+/g, "-")}-${claimData.invoice}`,
          users: [username],
        };

        const permlink =
          `${jsonMetadata.business_name}-${jsonMetadata.invoice_id}`.toLowerCase();
        const operations = [
          [
            "comment",
            {
              parent_author: "",
              parent_permlink: "hive-106130",
              category: "hive-106130",
              author: username,
              permlink: permlink,
              title: title,
              body: body,
              json_metadata: JSON.stringify(jsonMetadata),
            },
          ],
          [
            "comment_options",
            {
              author: username,
              permlink: permlink,
              allow_votes: true,
              allow_curation_rewards: true,
              max_accepted_payout: "1000000.000 HBD",
              percent_hbd: 10000,
              extensions: [
                [
                  0,
                  {
                    beneficiaries: [
                      {
                        account: "distriator.bene",
                        weight: 6000, // 60%
                      },
                    ],
                  },
                ],
              ],
            },
          ],
        ];

        window.hive_keychain.requestBroadcast(
          username,
          operations,
          "posting",
          (response) => {
            if (response.success) {
              document.getElementById("status").textContent =
                "Post created successfully!";
              document.getElementById("status").className = "text-success";
              form.reset();
              form.classList.remove("was-validated");
            } else {
              document.getElementById("status").textContent =
                `Failed to create post: ${response.message}`;
              document.getElementById("status").className = "text-danger";
            }
          },
        );
      }

      // Check for existing token on page load
      window.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("distriator_token");
        if (token) {
          try {
            const payload = JSON.parse(atob(token.split(".")[1]));
            const username = payload.username || "User";
            showUserNav(username);
            fetchClaimsAndDisplay();
          } catch (err) {
            console.error("Error parsing token:", err);
            logout(); // Invalid token, clear it
          }
        } else {
          showLoginForm();
        }
      });

      // Add event listener for post form submission
      document
        .getElementById("postForm")
        .addEventListener("submit", createHivePost);
    </script>
  </body>
</html>
